# DTU File Tracking System (FTS)

An end-to-end file tracking system for the Accounts Department at DTU. This document is the single source of truth for presenting the project: architecture, setup, database schema and relationships, API surface, and frontend features.

---

## 1) Executive Summary

- Mission: Digitize movement and SLA tracking of departmental files, with auditability and role-based access.
- Stack:
  - Backend: Node.js + Express (TypeScript), PostgreSQL
  - Frontend: React + Vite + TypeScript + TailwindCSS
  - Auth: Session via JWT, role-based guards in API and UI
  - Observability: Audit logs for all reads/writes, SLA computation in DB + app
- Key features:
  - File intake, movement workflow, SLA tracking, share-by-token, dashboards
  - Role-aware views for Clerks, Accounts Officers, COF, and Admin
  - Search, filters, and quick duplicate/“similar subject” detection

---

## 2) Repository & Structure

```
ProjectFTS/
├─ docker-compose.yml
├─ backend/
│  ├─ src/
│  │  ├─ index.ts               # Express app bootstrap
│  │  ├─ routes/                # REST endpoints
│  │  │  ├─ files.ts            # Files CRUD, list, tokens, events, SLA
│  │  │  ├─ auth.ts             # Login
│  │  │  ├─ masterData.ts       # Offices/Categories/Users/SLA policies
│  │  │  ├─ reports.ts, dashboard.ts, users.ts, events.ts, cof.ts
│  │  ├─ db/                    # DB adapters and queries
│  │  ├─ middleware/            # auth, audit, validation
│  │  └─ schemas/               # zod schemas
│  ├─ latest.sql                # DB schema snapshot
│  └─ docs/FILES_API.md         # Additional API notes
└─ frontend/
   ├─ src/
   │  ├─ pages/                 # Screens (Login, Intake, Search, Detail, etc.)
   │  ├─ components/common/     # Shared UI (Sidebar, Header, Footer, Tables, etc.)
   │  ├─ services/              # API clients
   │  └─ assets/                # dtu-logo.png, new.jpg
   └─ vite + tailwind configs
```

---

## 3) How to run

### Option A: Docker
1. Ensure Docker is installed.
2. Copy environment (create minimal .env files if needed):
   - backend expects DATABASE_URL and JWT_SECRET (see backend README comments). For quick local dev with docker-compose, values are provided by the compose services.
3. From repo root, bring up stack:
   - docker-compose up -d
4. Access:
   - Frontend: http://localhost:5173 (Vite default if used in compose)
   - Backend:  http://localhost:3000
   - Postgres: localhost:5432

### Option B: Local dev
- Backend:
  - cd backend
  - npm install
  - Create .env with DATABASE_URL and JWT_SECRET
  - npm run dev (nodemon/ts-node)
- Frontend:
  - cd frontend
  - npm install
  - npm run dev

Demo credentials (frontend defaults prefilled):
- Clerk: clerk / clerk12345
- Officer: officer / officer12345
- COF: cof / cof12345
- Admin: admin / admin12345

Note: These are demo usernames; backend must have matching users in DB to authenticate.

---

## 4) Database schema (PostgreSQL)

The database schema is captured in `LatestDBExport.sql` / `db-export-final.sql` and applied by the backend migrations. Below is a functional overview of main tables, constraints, triggers, and relationships.

### 4.1 Tables (core)

- users
  - id (PK)
  - username, password_hash
  - name, email (optional)
  - role: one of Clerk, AccountsOfficer, COF, Admin
  - created_at, updated_at
  - Relationships: referenced by files.created_by, files.current_holder_user_id, file_events.from_user_id, file_events.to_user_id

- offices
  - id (PK), name
  - Used by files.owning_office_id

- categories
  - id (PK), name
  - Used by files.category_id and sla_policies.category_id

- files
  - id (PK)
  - file_no (generated by function generate_file_no()), subject, notesheet_title
  - owning_office_id (FK -> offices.id)
  - category_id (FK -> categories.id)
  - priority (ENUM sla_priority: Routine | Urgent | Critical)
  - confidentiality (boolean)
  - date_initiated, date_received_accounts
  - created_by (FK -> users.id)
  - current_holder_user_id (FK -> users.id)
  - status (CHECK): Draft | Open | WithOfficer | WithCOF | Dispatched | OnHold | WaitingOnOrigin | Closed
  - SLA snapshot columns (persisted by backend helpers): sla_minutes, sla_consumed_minutes, sla_percent, sla_remaining_minutes, sla_status, etc.
  - Relationships: 1–many to file_events, 1–many to attachments, 1–1 (or 1–many historical) to file_share_tokens

- file_events
  - id (PK), file_id (FK -> files.id)
  - action_type (CHECK): Forward | Return | SeekInfo | Hold | Escalate | Close | Dispatch | Reopen | SLAReason
  - from_user_id (nullable), to_user_id (nullable)
  - remarks, started_at, ended_at, business_minutes (updated by trigger)
  - Trigger/flow updates SLA and audit trail

- attachments
  - id (PK)
  - file_id (FK -> files.id)
  - file_event_id (FK -> file_events.id)
  - file_path, file_type, uploaded_at

- sla_policies
  - id (PK)
  - category_id (FK -> categories.id)
  - name, sla_minutes, calc_mode, priority (ENUM sla_priority)
  - warning_pct, escalate_pct, pause_on_hold

- file_share_tokens
  - file_id (PK/FK -> files.id)
  - token (opaque, usually JWT stored in DB), created_by_user_id, last_used_at

- audit_logs
  - id (PK)
  - file_id (nullable), user_id (nullable)
  - action_type: Read | Write | Delete
  - action_details (JSON), action_at (timestamp)

- holidays
  - id (PK), date, description

- working_hours
  - id (PK), weekday (0–6), start_time, end_time

- daily_counters
  - counter_date, counter (used by generate_file_no())

- query_threads, sla_notifications
  - Support for queries/escalations and SLA notifications pipeline (IDs, refs, status, timestamps)

### 4.2 Views
- executive_dashboard: Pre-aggregated counts for high-level dashboards
- officer_queue: Joins of officers with queued files for work distribution

### 4.3 Enums and checks
- sla_priority ENUM: Routine | Urgent | Critical
- files.status CHECK: Draft | Open | WithOfficer | WithCOF | Dispatched | OnHold | WaitingOnOrigin | Closed
- file_events.action_type CHECK: Forward | Return | SeekInfo | Hold | Escalate | Close | Dispatch | Reopen | SLAReason
- users.role CHECK: Clerk | AccountsOfficer | COF | Admin

### 4.4 Functions & Triggers (business logic)

- calculate_business_minutes(start_ts, end_ts)
  - Computes minutes within configured business hours; respects weekends/holidays.

- update_business_minutes() [trigger for file_events]
  - When an event is completed (ended_at set), updates business_minutes field using the function above.

- update_file_sla(p_file_id)
  - Recomputes and persists SLA snapshot fields on `files` for the given file.

- file_events_after_change() [trigger]
  - After INSERT/UPDATE on file_events, recompute SLA for affected file.

- generate_file_no()
  - Generates a unique, date-based file number using daily_counters (row lock to ensure atomic increments).

### 4.5 Relationships overview

- files.created_by        → users.id (many files per user)
- files.current_holder    → users.id (many files per holder)
- files.owning_office_id  → offices.id
- files.category_id       → categories.id
- file_events.file_id     → files.id (timeline of actions)
- file_events.from_user   → users.id (nullable)
- file_events.to_user     → users.id (nullable)
- attachments.file_id     → files.id
- attachments.file_event  → file_events.id
- sla_policies.category   → categories.id (priority-specific SLA)
- file_share_tokens.file  → files.id (stable share link per file)

ER (simplified):
```
users ─┬──────────────┐
       │              │
       │ created_by   │ current_holder
       ▼              ▼
             files ────────┐
               │           │
               │           └── file_share_tokens
               │
               ├── file_events ── attachments
               │
               ├── category_id → categories ──┐
               │                               └── sla_policies (by category + priority)
               └── owning_office_id → offices
```

---

## 5) Backend API (selected endpoints)

Base URL: `/` (e.g., http://localhost:3000)

Auth
- POST `/auth/login` { username, password } → { token, user }

Files
- GET `/files` — list with filters: q, status, office, creator, holder, page, limit, sort_by, sort_dir, includeSla=true|false
- POST `/files` — create file (requires auth). Also returns helpful `checklist` and `duplicates` (naive search by subject in last 30 days)
- GET `/files/next-number` — generate the next file number
- GET `/files/:id` — get file details (auth + authorization checks)
- GET `/files/:id/events` — list timeline
- POST `/files/:id/events` — add movement/event ({ to_user_id?, action_type, remarks })
- POST `/files/:id/token` — create or retrieve a stable share token (authorized roles)
- GET `/files/:id/token` — read existing share token

Token-only sharing (server validates tokens and id/token consistency)
- GET `/files/shared/files/:token` — fetch file via token
- GET `/files/shared/events/:token` — events via token
- GET `/files/shared/:id/:token` — file via token with id match
- GET `/files/shared/:id/:token/events` — events via token with id match

Master data
- GET `/master/offices`, `/master/categories`, `/master/sla-policies`, `/master/users?role=...`

Security & Authorization
- Clerk: create files (creator), limited read
- AccountsOfficer: holder-based views and actions
- COF/Admin: elevated read/write, dashboard access

Audit
- All read/write routes instrument audit logs with route, query, and counts.

---

## 6) Frontend (React + Vite + Tailwind)

Key pages
- LoginPage
  - Prefills Clerk demo credentials; DTU logo, campus background with dark overlay
- FileIntakePage
  - Intake form with category/priority-driven SLA preview
  - New: right-side panel with “Similar files” (debounced search by subject)
- FileSearchPage
  - Server-side pagination, sorting, and filters; role-aware toggles
- FileDetailPage
  - Timeline, movement actions, SLA reason modal, QR/token sharing
- DashboardPage, AdminDashboardPage, OfficerKanbanPage, ReportsPage, COFReviewPage, MyFilesPage

Common components
- Sidebar (light theme, DTU logo + text), Header (compact), Footer (slimmed, light), FileSearchTable, MovementForm, StatusBadge, Timeline, Modals

Services
- `src/services/*.ts` wraps REST API with axios (configured in `api.ts`)

Styling/Theming
- Tailwind-based design system; consistent slate/indigo palette
- Logo file: `src/assets/dtu-logo.png`
- Login background: `src/assets/new.jpg` at 50% opacity with a dark overlay

---

## 7) Workflow details

Intake → Holder assignment → Events → SLA
- Clerk initiates a File with subject, notesheet, owning office, category, priority, etc.
- On create (non-draft), system sets status=WithOfficer and creates an initial Forward event to the selected officer.
- SLA policy is resolved by Category + Priority; live SLA snapshot is computed (and optionally persisted) on reads and on event changes (triggers + backend helpers).
- Movement actions (Forward, Return, Hold, etc.) update timeline and SLA consumption.

Duplicate detection (UX)
- On create response, API returns `duplicates` (naive search by subject in last 30 days).
- On the intake page, a “Similar files” panel debounces subject and lists recent matches (last 60 days, up to 8).

Share-by-token
- Authorized users can generate a durable, stable token per file; token-guarded read routes exist.

Audit logging
- Every meaningful read/write captures route, filters, counts, user, and timestamps in `audit_logs`.

---

## 8) Presenting the data model (table-by-table quick reference)

Below is a condensed reference of key columns and links (derived from the export and backend code paths):

- users(id PK, username, password_hash, role CHECK, name, email, created_at, updated_at)
- offices(id PK, name)
- categories(id PK, name)
- sla_policies(id PK, category_id FK, name, sla_minutes, calc_mode, priority ENUM, warning_pct, escalate_pct, pause_on_hold)
- files(
  id PK, file_no, subject, notesheet_title,
  owning_office_id FK→offices, category_id FK→categories,
  priority ENUM, confidentiality bool,
  date_initiated, date_received_accounts,
  created_by FK→users, current_holder_user_id FK→users,
  status CHECK, [sla_* snapshot fields]
)
- file_events(id PK, file_id FK→files, action_type CHECK, from_user_id FK→users, to_user_id FK→users, remarks, started_at, ended_at, business_minutes)
- attachments(id PK, file_id FK→files, file_event_id FK→file_events, file_path, file_type, uploaded_at)
- file_share_tokens(file_id PK/FK→files, token, created_by_user_id, last_used_at)
- audit_logs(id PK, file_id, user_id, action_type, action_details JSON, action_at)
- holidays(id PK, date, description)
- working_hours(id PK, weekday 0..6, start_time, end_time)
- daily_counters(counter_date, counter)
- query_threads(id PK, file_id, created_by, status CHECK, subject, description, created_at, resolved_at)
- sla_notifications(id PK, file_id, notification_type, sent_at, processed_at)

Triggers/Functions
- calculate_business_minutes(), update_business_minutes() on file_events
- update_file_sla() + file_events_after_change() to maintain SLA snapshot in files
- generate_file_no() using daily_counters

Views
- executive_dashboard (counts)
- officer_queue (officer queues)

---

## 9) Security model & roles

- Clerk: create files, view own files
- AccountsOfficer: view/act on assigned files
- COF/Admin: broad read/write across files and reports
- All endpoints protected where appropriate; token-only paths for share links are segregated and validated

---

## 10) Extensibility ideas

- Attachments pipeline and preview UI (currently placeholder table exists)
- More advanced duplicate detection (trigram/fuzzy search in SQL)
- Notifications (email/Teams) from `sla_notifications`
- Analytics dashboards leveraging `executive_dashboard` & `officer_queue`
- RBAC refinements via dedicated permission tables

---

## 11) Troubleshooting

- Can’t login in demo? Ensure the DB has matching demo users with the passwords set (see backend/reset-password.js or a seed script).
- Missing SLA on list? Ensure `includeSla=true` is passed or run the persistence path as implemented in routes.
- File number collisions: inspect `daily_counters` and `generate_file_no()`; ensure single writer per date in multi-instance setups.

---

## 12) Credits

Developed for Delhi Technological University (DTU) Accounts Department.

If you need a printed architecture slide, export the “Repository & Structure”, “ER (simplified)” block, and “Workflow details” from this document.
